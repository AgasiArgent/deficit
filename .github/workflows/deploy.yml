name: Deploy Deficit Bot

on:
  push:
    branches:
      - master
      - main
  workflow_dispatch:  # –ü–æ–∑–≤–æ–ª—è–µ—Ç –∑–∞–ø—É—Å–∫–∞—Ç—å –≤—Ä—É—á–Ω—É—é

jobs:
  deploy:
    runs-on: ubuntu-latest

    steps:
      - name: Checkout code
        uses: actions/checkout@v4

      - name: Deploy to VPS
        uses: appleboy/ssh-action@v1.0.0
        with:
          host: ${{ secrets.VPS_HOST }}
          username: ${{ secrets.VPS_USERNAME }}
          key: ${{ secrets.VPS_SSH_KEY }}
          script: |
            echo "üöÄ Starting deployment..."

            # –°–æ–∑–¥–∞—Ç—å –¥–∏—Ä–µ–∫—Ç–æ—Ä–∏—é –ø—Ä–æ–µ–∫—Ç–∞
            mkdir -p /root/deficit
            cd /root/deficit

            # –ö–ª–æ–Ω–∏—Ä–æ–≤–∞—Ç—å –∏–ª–∏ –æ–±–Ω–æ–≤–∏—Ç—å —Ä–µ–ø–æ–∑–∏—Ç–æ—Ä–∏–π
            if [ -d ".git" ]; then
              echo "üì• Pulling latest changes..."
              git pull origin master
            else
              echo "üì¶ Cloning repository..."
              git clone https://github.com/${{ github.repository }}.git .
            fi

            # –°–æ–∑–¥–∞—Ç—å .env –µ—Å–ª–∏ –Ω–µ —Å—É—â–µ—Å—Ç–≤—É–µ—Ç
            if [ ! -f .env ]; then
              echo "üìù Creating .env file..."
              echo "TELEGRAM_BOT_TOKEN=${{ secrets.TELEGRAM_BOT_TOKEN }}" > .env
              echo "OWNER_USER_ID=${{ secrets.OWNER_USER_ID }}" >> .env
            fi

            # –°–æ–∑–¥–∞—Ç—å –¥–∏—Ä–µ–∫—Ç–æ—Ä–∏—é –¥–ª—è –¥–∞–Ω–Ω—ã—Ö
            mkdir -p data

            # –û—Å—Ç–∞–Ω–æ–≤–∏—Ç—å —Å—Ç–∞—Ä—ã–π –∫–æ–Ω—Ç–µ–π–Ω–µ—Ä
            echo "üõë Stopping old container..."
            docker-compose down || true

            # –°–æ–±—Ä–∞—Ç—å –Ω–æ–≤—ã–π –æ–±—Ä–∞–∑
            echo "üî® Building Docker image..."
            docker-compose build

            # –ó–∞–ø—É—Å—Ç–∏—Ç—å –Ω–æ–≤—ã–π –∫–æ–Ω—Ç–µ–π–Ω–µ—Ä
            echo "‚úÖ Starting new container..."
            docker-compose up -d

            # –û—á–∏—Å—Ç–∏—Ç—å —Å—Ç–∞—Ä—ã–µ –æ–±—Ä–∞–∑—ã
            echo "üßπ Cleaning up..."
            docker image prune -af --filter "until=24h"

            # –ü–æ–∫–∞–∑–∞—Ç—å —Å—Ç–∞—Ç—É—Å
            echo "üìä Status:"
            docker-compose ps
            echo ""
            echo "üìù Recent logs:"
            docker-compose logs --tail=20 bot

            echo "üéâ Deployment complete!"
